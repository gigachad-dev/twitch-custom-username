// ==UserScript==
// @name        twitch-custom-username
// @version     0.0.2
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://gigachad-dev.github.io/twitch-custom-username/
// @match       https://*.twitch.tv/*
// @updateURL   https://gigachad-dev.github.io/twitch-custom-username/twitch-custom-username.meta.js
// @downloadURL https://gigachad-dev.github.io/twitch-custom-username/twitch-custom-username.user.js
// ==/UserScript==

var __defProp=Object.defineProperty,__defNormalProp=(i,s,o)=>s in i?__defProp(i,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[s]=o,__publicField=(i,s,o)=>(__defNormalProp(i,typeof s!="symbol"?s+"":s,o),o),__accessCheck=(i,s,o)=>{if(!s.has(i))throw TypeError("Cannot "+o)},__privateGet=(i,s,o)=>(__accessCheck(i,s,"read from private field"),o?o.call(i):s.get(i)),__privateAdd=(i,s,o)=>{if(s.has(i))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(i):s.set(i,o)},__privateSet=(i,s,o,f)=>(__accessCheck(i,s,"write to private field"),f?f.call(i,o):s.set(i,o),o);(function(){var i,s,o;function f(n,t,e){const a=new MutationObserver((r,c)=>{for(const l of r)t(l,c)});return a.observe(n,{childList:!0,subtree:!0,...e}),()=>a.disconnect()}const C="chat-line__message",v="user-notice-line",m="chat-author__display-name",p="data-user-id",d="customNames";class N{constructor(){__publicField(this,"reactInstanceKey",null)}getReactInstance(t){if(!this.reactInstanceKey){const e=Object.keys(t);if(!e.length)throw new Error("ReactInstance is not defined");this.reactInstanceKey=e[0]}return t[this.reactInstanceKey]}getUserId(t){const e=this.getReactInstance(t);return e.return.key?e.return.key.split("-").at(0):null}}const g=new N;function y(n){return Object.entries(n)}const I=(n,t)=>n;class E{constructor({encode:t=I,decode:e=I,attributes:a={},initialValue:r}={}){if(__privateAdd(this,i,void 0),__privateAdd(this,s,void 0),__privateAdd(this,o,void 0),__privateSet(this,i,t),__privateSet(this,s,e),this.attributes=a,r)for(const[c,l]of y(r))this.has(c)||this.set(c,l)}get attributes(){return __privateGet(this,o)}set attributes(t){__privateSet(this,o,t)}get(t){const e=`; ${document.cookie}`.match(`;\\s*${t}=([^;]+)`);return e?__privateGet(this,s).call(this,decodeURIComponent(e[1]),t):null}set(t,e,a){const r={path:"/",...__privateGet(this,o),...a};typeof r.expires=="number"&&(r.expires=new Date(Date.now()+r.expires*864e5)),r.expires instanceof Date&&(r.expires=r.expires.toUTCString());let c=`${encodeURIComponent(t)}=${encodeURIComponent(__privateGet(this,i).call(this,e,t))}`;for(const[l,_]of y(r))c+=`; ${l}`,_!==!0&&(c+=`=${_}`);document.cookie=c}list(){const t=document.cookie,e=(t?t.split("; "):[]).map(a=>{const[r,c]=a.split(/=(.*)/);return[r,__privateGet(this,s).call(this,decodeURIComponent(c),r)]});return Object.fromEntries(e)}remove(t,e){this.set(t,null,{...e,expires:-1})}has(t){return!!this.get(t)}}i=new WeakMap,s=new WeakMap,o=new WeakMap;class w extends E{constructor(){super({initialValue:{[d]:[]},attributes:{domain:"twitch.tv","max-age":60*60*24*365},encode(t){return JSON.stringify(t)},decode(t){try{return JSON.parse(t)}catch{return null}}}),__publicField(this,"values"),this.values=this.get(d)}write(t){this.values=JSON.parse(t),this.set(d,this.values)}addCustomName(t){const[e,a]=t,r=this.get(d);this.values=r.filter(c=>c[0]!==e),a&&this.values.push(t),this.set(d,this.values)}getCustomNameById(t){const e=this.values.find(a=>a[0]===t);return e?e[1]:null}}const u=new w;function S(n,t){const e=n.getAttribute(p);if(e)return u.getCustomNameById(e);{const a=g.getUserId(t);return a?u.getCustomNameById(a):null}}function x(n){for(const t of n.addedNodes){if(t.nodeName==="#text")continue;const e=t;if(!(e.classList.contains(C)||e.classList.contains(v)))continue;const r=e.querySelector(`.${m}`);if(!r)continue;const c=S(e,r);c&&(r.innerHTML=`${r.textContent} (${c})`)}}function A(n){n.altKey&&n.code==="KeyQ"&&(n.preventDefault(),navigator.clipboard.writeText(JSON.stringify(u.values)).then(()=>alert("Copied to clipboard!")))}function R(n){if(n.altKey&&n.code==="KeyW"){n.preventDefault();const t=prompt("Set a new storage value:",JSON.stringify(u.values));t&&u.write(t)}}function b(n){const t=n.target;if(n.altKey&&t.classList.contains(m)){n.preventDefault();const e=g.getUserId(t)||t.parentElement.parentElement.getAttribute(p)||t.parentElement.parentElement.parentElement.getAttribute(p);if(!e){alert("User id is not defined");return}const a=u.getCustomNameById(e),r=prompt(`Set a custom name for ${t.textContent}:`,a??"");if(r===null)return;u.addCustomName([e,r])}}const h={exportConfig:A,importConfig:R,addCustomUsername:b};document.addEventListener("keydown",n=>{h.importConfig(n),h.exportConfig(n)}),document.addEventListener("contextmenu",n=>{h.addCustomUsername(n)}),f(document.body,n=>x(n))})();
