(function(){"use strict";function g(s,t,e){const r=new MutationObserver((n,o)=>{for(const i of n)t(i,o)});return r.observe(s,{childList:!0,subtree:!0,...e}),()=>r.disconnect()}const y="chat-line__message",C="user-notice-line",m="chat-author__display-name",c="data-user-id",l="__reactInternalInstance",u="https://twurple-bot.na4u.ru/userscript";class A{reactInternalInstanceKey=null;getReactInstance(t){if(!this.reactInternalInstanceKey){const e=Object.keys(t).find(r=>r.startsWith(l));if(!e)throw new Error(`${l} is not defined`);this.reactInternalInstanceKey=e}return t[this.reactInternalInstanceKey]}getUserId(t){const e=this.getReactInstance(t);return e.return.key?e.return.key.split("-").at(0):null}}const f=new A;async function S(s){const t=new URLSearchParams;return t.set("username",s),await(await fetch(u+"/check-user?"+t)).json()}async function U(){return await(await fetch(u+"/users")).json()}async function R(s){const e=await(await fetch(u+"/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(e.error)throw new Error(e.error)}function h(s){return Object.entries(s)}const p=(s,t)=>s;class _{#s;#t;#e;constructor({encode:t=p,decode:e=p,attributes:r={},initialValue:n}={}){if(this.#s=t,this.#t=e,this.attributes=r,n)for(const[o,i]of h(n))this.has(o)||this.set(o,i)}get attributes(){return this.#e}set attributes(t){this.#e=t}get(t){const e=`; ${document.cookie}`.match(`;\\s*${t}=([^;]+)`);return e?this.#t(decodeURIComponent(e[1]),t):null}set(t,e,r){const n={path:"/",...this.#e,...r};typeof n.expires=="number"&&(n.expires=new Date(Date.now()+n.expires*864e5)),n.expires instanceof Date&&(n.expires=n.expires.toUTCString());let o=`${encodeURIComponent(t)}=${encodeURIComponent(this.#s(e,t))}`;for(const[i,E]of h(n))o+=`; ${i}`,E!==!0&&(o+=`=${E}`);document.cookie=o}list(){const t=document.cookie,e=(t?t.split("; "):[]).map(r=>{const[n,o]=r.split(/=(.*)/);return[n,this.#t(decodeURIComponent(o),n)]});return Object.fromEntries(e)}remove(t,e){this.set(t,null,{...e,expires:-1})}has(t){return!!this.get(t)}}class N{cookie;constructor(){this.cookie=new _({attributes:{domain:"twitch.tv","max-age":60*60*24*365}})}get(){return this.cookie.get("password")}write(t){this.cookie.set("password",t)}}const I=new N;class b{STORAGE_VALUES=[];get values(){return this.STORAGE_VALUES}constructor(){this.init()}async init(){setInterval(()=>this.read(),60*1e3),this.read()}async read(){return this.STORAGE_VALUES=await U(),this.STORAGE_VALUES}async setCustomName(t){try{const e=I.get(),r=await this.read();this.STORAGE_VALUES=r.filter(n=>n.id!==t.id),t.name&&this.STORAGE_VALUES.push(t),await R({...t,password:e})}catch(e){alert(e.message)}}getCustomName(t){const e=this.STORAGE_VALUES.find(r=>r.id===t);return e?e.name:null}}const a=new b;function T(s,t){const e=s.getAttribute(c);if(e)return a.getCustomName(e);{const r=f.getUserId(t);return r?a.getCustomName(r):null}}function L(s){for(const t of s.addedNodes){if(t.nodeName==="#text")continue;const e=t;if(!(e.classList.contains(y)||e.classList.contains(C)))continue;const n=e.querySelector(`.${m}`);if(!n)continue;const o=T(e,n);o&&(n.innerHTML=`${n.textContent} (${o})`)}}function k(s){const t=s.target;if(s.altKey&&t.classList.contains(m)){s.preventDefault();const e=f.getUserId(t)||t.parentElement.parentElement.getAttribute(c)||t.parentElement.parentElement.parentElement.getAttribute(c);if(!e){alert("\u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D userId.");return}const r=a.getCustomName(e),n=prompt(`\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u0438\u043C\u044F \u0434\u043B\u044F \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F ${t.textContent}:`,r??"");if(n===null)return;a.setCustomName({id:e,name:n})}}async function w(s){if(s.altKey&&s.key==="1"){s.preventDefault();const t=prompt("\u041F\u043E\u0438\u0441\u043A \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u043F\u043E \u043D\u0438\u043A\u043D\u0435\u0439\u043C\u0443:");if(!t)return;O(s,t)}}async function O(s,t){const e=await S(t);if(e.error)return alert(e.error),w(s);const r=a.getCustomName(e.id),n=prompt(`\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u0438\u043C\u044F \u0434\u043B\u044F \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F ${e.displayName}:`,r??"");n!==null&&a.setCustomName({id:e.id,name:n})}function $(s){if(s.altKey&&s.key==="2"){s.preventDefault();const t=prompt("\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A API:");if(!t)return;I.write(t)}}const d={addCustomUsernameFromChat:k,addCustomUsername:w,editPassword:$};document.addEventListener("keydown",s=>{d.addCustomUsername(s),d.editPassword(s)}),document.addEventListener("contextmenu",s=>{d.addCustomUsernameFromChat(s)}),g(document.body,s=>L(s))})();
